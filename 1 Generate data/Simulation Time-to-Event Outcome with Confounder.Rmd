---
title: "Identifying Heterogeneous Treatment Effects: Simulation"
date: "Last run: `r Sys.time()`"
params:
    scenario: 
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE,
                      message = FALSE)

library(tidyverse)
library(gtsummary)
library(grf)
library(policytree)
library(gt)
library(survival)
library(survminer)
library(patchwork)

set.seed(1123)

# load analysis dataset from application
load(here::here("data/project 1/application/analysis_df_nsclc_pdl1_positive.rdata"))

# formatting
theme_set(theme_bw() + theme(legend.position = "bottom"))
```

# Scenario `r params$scenario`

## Overview {.tabset .tabsetfade}

* **Goal: ** Simulate two latent subgroups with different treatment effect

### Data Simulation {.tabset .tabsetfade}

```{r}
# n samples to simulate - based on true number eligible for analysis
n <- nrow(analysis_df_pdl1_positive)

# scenario
scenario <- params$scenario
```

#### Simulation Parameters

```{r}
simulation_scenarios_all <- tibble::tribble(
  ~setting, ~n_modifier, ~pdl1_with_latent_subgroup, ~tx_intercept, ~tx_pdl1_coefficient, ~intercept_latent_subgroup_model, ~latent_subgroup_pdl1_coefficient, ~intercept_coef, ~tx_coef, ~latent_subgroup_coef, ~interaction_coef, ~age_coef, ~error_sd, ~censoring_scale_parameter, ~censoring_age_coef, ~censoring_sex_coef,
  "Setting A", 1, "Strong", 0.2, 0.5, 0, 2.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 0.5, "Strong", 0.2, 0.5, 0, 2.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 2, "Strong", 0.2, 0.5, 0, 2.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 1, "Moderate", 0.2, 0.5, 0, 1.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 1, "Weak", 0.2, 0.5, 0, 0.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 0.5, "Moderate", 0.2, 0.5, 0, 1.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 2, "Moderate", 0.2, 0.5, 0, 1.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 0.5, "Weak", 0.2, 0.5, 0, 0.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting A", 2, "Weak", 0.2, 0.5, 0, 0.3, -0.29, -0.81, 0.51, 1.1, -0.03, 0.5, 5, -0.03, 0.1,
  "Setting C", 1, "Strong", 0.2, 0.5, 0, 2.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 0.5, "Strong", 0.2, 0.5, 0, 2.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 2, "Strong", 0.2, 0.5, 0, 2.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 0.5, "Moderate", 0.2, 0.5, 0, 1.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 1, "Moderate", 0.2, 0.5, 0, 1.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 2, "Moderate", 0.2, 0.5, 0, 1.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 0.5, "Weak", 0.2, 0.5, 0, 0.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 1, "Weak", 0.2, 0.5, 0, 0.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting C", 2, "Weak", 0.2, 0.5, 0, 0.3, -1.6258, -0.54, 0.6978, 0.6704, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 1, "Strong", 0.2, 0.5, 0, 2.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 0.5, "Strong", 0.2, 0.5, 0, 2.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 2, "Strong", 0.2, 0.5, 0, 2.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 0.5, "Moderate", 0.2, 0.5, 0, 1.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 1, "Moderate", 0.2, 0.5, 0, 1.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 2, "Moderate", 0.2, 0.5, 0, 1.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 0.5, "Weak", 0.2, 0.5, 0, 0.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 1, "Weak", 0.2, 0.5, 0, 0.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting B", 2, "Weak", 0.2, 0.5, 0, 0.3, -1.6258, -0.54, 1.6, -0.3, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting D", 2, NA, 0.2, 0.5, 0, 0, -0.69, 0.69, 0, 0, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting D", 1, NA, 0.2, 0.5, 0, 0, -0.69, 0.69, 0, 0, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting D", 0.5, NA, 0.2, 0.5, 0, 0, -0.69, 0.69, 0, 0, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting E", 2, NA, 0.2, 0.5, 0, 0, -0.69, 0, 0, 0, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting E", 1, NA, 0.2, 0.5, 0, 0, -0.69, 0, 0, 0, -0.03, 0.5, 2, -0.03, 0.1,
  "Setting E", 0.5, NA, 0.2, 0.5, 0, 0, -0.69, 0, 0, 0, -0.03, 0.5, 2, -0.03, 0.1
)
```


```{r}
# df of simulation parameters
simulation_scenarios <- simulation_scenarios_all %>% 
  filter(scenario_var == scenario)

# print simulation parameters
gt::gt(simulation_scenarios)

# assign simulation parameters as objects in the environment
list2env(as.list(simulation_scenarios %>%
                   select(n_modifier, iter = n_iter,
                          # outcome model
                          intercept_coef, tx_coef, interaction_coef,
                          latent_subgroup_coef, age_coef,
                          interaction_age_latent_subgroup,
                          outc_pdl1_coef,
                          interaction_pdl1_latent_subgroup, 
                          error_sd,
                          # censoring probability parameters
                          censoring_scale_parameter,
                          censoring_age_coef, censoring_sex_coef,
                          # latent subgroup model
                          pdl1_var_for_latent_subgroup, 
                          intercept_latent_subgroup_model,
                          latent_subgroup_pdl1_coefficient,
                          # treatment model
                          tx_intercept,
                          tx_pdl1_coefficient)),
               envir = knitr::knit_global())
```

```{r}
# simulations with age
sims_with_age <- as.logical(nrow(simulation_scenarios %>% 
  filter(age_coef != 0) == 0))
```

```{r}
set.seed(1231)

# if using x-times the sample size, base it off of a random sample with replacement
if (n_modifier == 1){
  # need object names to be the same for below df
  analysis_df_pdl1_positive_sample <- analysis_df_pdl1_positive
} else if (n_modifier != 1){
  analysis_df_pdl1_positive_sample <- analysis_df_pdl1_positive %>% 
  sample_frac(n_modifier, replace = TRUE)
}
```

#### Treatment Probabilities

* PDL1 associated with increased likelihood of receiving IO alone

```{r}
set.seed(1123)

##### simulate treatments given PDL1
# intercept based on P(tx) = 0.56 across all patients in the data
xb_tx <- tx_intercept + tx_pdl1_coefficient*analysis_df_pdl1_positive_sample$pdl1_perc_norm
p_tx <- 1/(1 + exp(-xb_tx))
# plot(p_tx)
length(p_tx)

# additional % increase in P(tx 1) with 1-unit increase in PDL1
100*(plogis(tx_intercept + tx_pdl1_coefficient)-plogis(tx_intercept))
```

#### Latent Subgroup Probabilities

* PDL1 associated with increased likelihood of being in subgroup 1

```{r}
set.seed(1123)

##### simulate latent subgroup given PDL1
xb_latent_subgroup <- intercept_latent_subgroup_model +
  latent_subgroup_pdl1_coefficient*pull(analysis_df_pdl1_positive_sample, pdl1_var_for_latent_subgroup) 

p_latent_subgroup <- 1/(1 + exp(-xb_latent_subgroup))
# plot(p_latent_subgroup)
length(p_latent_subgroup)

# additional % increase in P(subgroup 1) with 1-unit increase in PDL1
100*(plogis(intercept_latent_subgroup_model + latent_subgroup_pdl1_coefficient)-plogis(intercept_latent_subgroup_model))
```

#### Time-to-Event Endpoint

```{r}
set.seed(1231)

# run time is <2 minutes for 1000 iterations
tstart <- Sys.time()

sim_data_tte <- map(c(1:iter),
                    ~tibble(
                      iteration = .x,
  # use true PDL1 based on the data
  pdl1_perc = analysis_df_pdl1_positive_sample$pdl1_perc,
  pdl1_perc_norm =
      analysis_df_pdl1_positive_sample$pdl1_perc_norm,
  pdl1_perc_centered = 
      analysis_df_pdl1_positive_sample$pdl1_perc_centered,
  # pdl1_perc_norm = rnorm(n = round(n*n_modifier),
  #                            0, 1),
  # simulate treatment group given PDL1
  tx = rbinom(round(n*n_modifier), size = 1, prob = p_tx),  
  # latent subgroup
  latent_subgroup = rbinom(round(n*n_modifier), size = 1, prob = p_latent_subgroup),
  # use true age observed in the data
  age_dx_centered = analysis_df_pdl1_positive_sample$age_centered,
  # use observed sex
  female = analysis_df_pdl1_positive_sample$female,
  # outcome
  # exponentiate continuous outc_yrs
  event_time = exp(intercept_coef + 
               tx_coef*tx +
                 # latent subgroup effect
               latent_subgroup_coef*latent_subgroup +
               interaction_coef*latent_subgroup*tx +
                 # continuous covariate
               age_coef*age_dx_centered +
                 # random error
               rnorm(n = round(n*n_modifier), mean = 0, sd = error_sd)), 
  # impose administrative censoring at 6 years
  censoring_time_weibull = rweibull(n = round(n*n_modifier), 
                                shape = 1, # exponential
                                scale = censoring_scale_parameter*exp(censoring_sex_coef*female +
                                censoring_age_coef*age_dx_centered)),
  censoring_time = pmin(censoring_time_weibull, 6),
  # time to event is the earlier of the simulated event and censoring times, or administrative censoring at 6 years
  outc_yrs = pmin(event_time, censoring_time),
  # take log of outcome for log-normal models
  log_outc_yrs = log(outc_yrs),
  status = case_when(
    event_time <= censoring_time ~ 1,
    censoring_time < event_time ~ 0
  ),
  # reverse status indicator for a censoring indicator
  censoring_indicator = case_when(
    status == 0 ~ 1,
    status == 1 ~ 0)
  )
) # end loop over number of iterations

tstop <- Sys.time()
tstop-tstart
```